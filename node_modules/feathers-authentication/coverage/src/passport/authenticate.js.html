<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for src/passport/authenticate.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../prettify.css" />
    <link rel="stylesheet" href="../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../index.html">All files</a> / <a href="index.html">src/passport</a> authenticate.js
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">90.91% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>40/44</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">78.38% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>29/37</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">90% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>9/10</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">90.24% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>37/41</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">48x</span>
<span class="cline-any cline-yes">48x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">172x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">86x</span>
<span class="cline-any cline-yes">83x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">83x</span>
<span class="cline-any cline-yes">83x</span>
<span class="cline-any cline-yes">83x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">83x</span>
<span class="cline-any cline-yes">42x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">42x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">83x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">83x</span>
<span class="cline-any cline-yes">83x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">83x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">83x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">83x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">83x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">83x</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">83x</span>
<span class="cline-any cline-yes">37x</span>
<span class="cline-any cline-yes">37x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">83x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">83x</span>
<span class="cline-any cline-yes">40x</span>
<span class="cline-any cline-yes">40x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">83x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">83x</span>
<span class="cline-any cline-yes">83x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">/*
 * An authentication function that is called by
 * app.authenticate. Inspired by
 * https://github.com/jaredhanson/passport/blob/master/lib/middleware/authenticate.js
 */
import makeDebug from 'debug';
&nbsp;
const debug = makeDebug('feathers-authentication:passport:authenticate');
&nbsp;
export default function authenticate (options = {}) {
  debug('Initializing custom passport authenticate', options);
&nbsp;
  // This function is bound by passport and called by passport.authenticate()
  return function (passport, strategies, strategyOptions = {}, callback = <span class="fstat-no" title="function not covered" >() =&gt; </span>{}) <span class="branch-0 cbranch-no" title="branch not covered" >{</span>
    // This is called by the feathers middleware, hook or socket. The request object
    // is a mock request derived from an http request, socket object, or hook.
    return function (request = <span class="branch-1 cbranch-no" title="branch not covered" >{}) {</span>
      return new Promise((resolve, reject) =&gt; {
        // TODO (EK): Support transformAuthInfo
&nbsp;
        // Allow you to set a location for the success payload.
        // Default is hook.params.user, req.user and socket.user.
        const entity = strategyOptions.entity || strategyOptions.assignProperty || options.entity;
        request.body = request.body || <span class="branch-1 cbranch-no" title="branch not covered" >{};</span>
        let strategyName = request.body.strategy;
&nbsp;
        if (!strategyName) {
          <span class="missing-if-branch" title="if path not taken" >I</span>if (Array.isArray(strategies)) {
<span class="cstat-no" title="statement not covered" >            strategyName = strategies[0];</span>
          } else {
            strategyName = strategies;
          }
        }
&nbsp;
        <span class="missing-if-branch" title="if path not taken" >I</span>if (!strategyName) {
<span class="cstat-no" title="statement not covered" >          return reject(new Error(`You must provide an authentication 'strategy'`));</span>
        }
&nbsp;
        // Make sure `strategies` is an array, allowing authentication to pass through a chain of
        // strategies.  The first name to succeed, redirect, or error will halt
        // the chain.  Authentication failures will proceed through each strategy in
        // series, ultimately failing if all strategies fail.
        //
        // This is typically used on API endpoints to allow clients to authenticate
        // using their preferred choice of Basic, Digest, token-based schemes, etc.
        // It is not feasible to construct a chain of multiple strategies that involve
        // redirection (for example both Facebook and Twitter), since the first one to
        // redirect will halt the chain.
        <span class="missing-if-branch" title="else path not taken" >E</span>if (!Array.isArray(strategies)) {
          strategies = [strategies];
        }
&nbsp;
        // Return an error if the client is trying to authenticate with a strategy
        // that the server hasn't allowed for this authenticate call. This is important
        // because it prevents the user from authenticating with a registered strategy
        // that is not being allowed for this authenticate call.
        <span class="missing-if-branch" title="if path not taken" >I</span>if (!strategies.includes(strategyName)) {
<span class="cstat-no" title="statement not covered" >          return reject(new Error(`Invalid authentication strategy '${strategyName}'`));</span>
        }
&nbsp;
        // Get the strategy, which will be used as prototype from which to create
        // a new instance.  Action functions will then be bound to the strategy
        // within the context of the HTTP request/response pair.
        let prototype = passport._strategy(strategyName);
&nbsp;
        <span class="missing-if-branch" title="if path not taken" >I</span>if (!prototype) {
<span class="cstat-no" title="statement not covered" >          return reject(new Error(`Unknown authentication strategy '${strategyName}'`));</span>
        }
&nbsp;
        // Implement required passport methods that
        // can be called by a passport strategy.
        let strategy = Object.create(prototype);
&nbsp;
        strategy.redirect = (url, status = 302) =&gt; {
          debug(`'${strategyName}' authentication redirecting to`, url, status);
          resolve({ redirect: true, url, status });
        };
&nbsp;
        strategy.fail = (challenge, status) =&gt; {
          debug(`Authentication strategy '${strategyName}' failed`, challenge, status);
          resolve({
            fail: true,
            challenge,
            status
          });
        };
&nbsp;
        strategy.error = error =&gt; {
          debug(`Error in '${strategyName}' authentication strategy`, error);
          reject(error);
        };
&nbsp;
        strategy.success = (data, payload) =&gt; {
          debug(`'${strategyName}' authentication strategy succeeded`, data, payload);
          resolve({
            success: true,
            data: {
              [entity]: data,
              payload
            }
          });
        };
&nbsp;
        strategy.pass = () =&gt; {
          debug(`Passing on '${strategyName}' authentication strategy`);
          resolve();
        };
&nbsp;
        debug('Passport request object', request);
        strategy.authenticate(request, strategyOptions);
      });
    };
  };
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="https://istanbul.js.org/" target="_blank">istanbul</a> at Mon Oct 23 2017 17:25:04 GMT-0600 (MDT)
</div>
</div>
<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../sorter.js"></script>
</body>
</html>
